"""Exploitation module â€” SearchSploit, CVE lookup, Metasploit."""
from __future__ import annotations
from PyQt6.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QLabel, QPushButton, QLineEdit,
    QTabWidget, QFormLayout, QGroupBox, QTextEdit, QSplitter, QTableWidget,
    QTableWidgetItem, QHeaderView
)
from PyQt6.QtCore import Qt, pyqtSignal
from redteamai.gui.widgets.terminal_output import TerminalWidget
from redteamai.gui.widgets.finding_badge import FindingBadge


class ExploitationModule(QWidget):
    run_tool = pyqtSignal(str, dict)
    ask_ai = pyqtSignal(str)
    save_finding = pyqtSignal(dict)

    def __init__(self, parent=None):
        super().__init__(parent)
        layout = QVBoxLayout(self)
        layout.setContentsMargins(0, 0, 0, 0)
        layout.setSpacing(0)

        # Header
        header = QWidget()
        header.setStyleSheet("background:#161b22; border-bottom:1px solid #30363d;")
        hl = QHBoxLayout(header)
        hl.setContentsMargins(16, 10, 16, 10)
        title = QLabel("Exploitation & Vulnerability Research")
        title.setObjectName("heading")
        warning = QLabel("âš ï¸ Authorized targets only")
        warning.setObjectName("warning")
        warning.setStyleSheet("color:#d29922; font-size:12px; background:transparent;")
        hl.addWidget(title)
        hl.addStretch()
        hl.addWidget(warning)
        layout.addWidget(header)

        # Tabs
        tabs = QTabWidget()
        tabs.addTab(self._build_searchsploit_tab(), "SearchSploit")
        tabs.addTab(self._build_cve_tab(), "CVE Lookup")
        tabs.addTab(self._build_metasploit_tab(), "Metasploit")
        layout.addWidget(tabs)

    def _build_searchsploit_tab(self) -> QWidget:
        w = QWidget()
        layout = QVBoxLayout(w)
        layout.setContentsMargins(16, 16, 16, 16)
        layout.setSpacing(12)

        search_row = QHBoxLayout()
        self._ss_query = QLineEdit()
        self._ss_query.setPlaceholderText("e.g. Apache 2.4.49, WordPress 5.8, vsftpd 2.3.4")
        self._ss_query.returnPressed.connect(self._run_searchsploit)
        search_btn = QPushButton("Search")
        search_btn.setObjectName("primary")
        search_btn.clicked.connect(self._run_searchsploit)
        ai_btn = QPushButton("ðŸ¤– Ask AI about this exploit")
        ai_btn.clicked.connect(self._ai_searchsploit)

        search_row.addWidget(QLabel("Query:"))
        search_row.addWidget(self._ss_query, 1)
        search_row.addWidget(search_btn)
        search_row.addWidget(ai_btn)
        layout.addLayout(search_row)

        self._ss_terminal = TerminalWidget()
        layout.addWidget(self._ss_terminal)
        return w

    def _build_cve_tab(self) -> QWidget:
        w = QWidget()
        layout = QVBoxLayout(w)
        layout.setContentsMargins(16, 16, 16, 16)
        layout.setSpacing(12)

        search_row = QHBoxLayout()
        self._cve_input = QLineEdit()
        self._cve_input.setPlaceholderText("CVE-2021-44228 or keyword 'log4j'")
        self._cve_input.returnPressed.connect(self._run_cve_lookup)
        cve_btn = QPushButton("Lookup")
        cve_btn.setObjectName("primary")
        cve_btn.clicked.connect(self._run_cve_lookup)

        search_row.addWidget(QLabel("CVE / Keyword:"))
        search_row.addWidget(self._cve_input, 1)
        search_row.addWidget(cve_btn)
        layout.addLayout(search_row)

        self._cve_output = QTextEdit()
        self._cve_output.setReadOnly(True)
        self._cve_output.setStyleSheet("background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:6px;")
        layout.addWidget(self._cve_output)

        save_btn = QPushButton("ðŸ’¾ Save as Finding")
        save_btn.clicked.connect(self._save_cve_finding)
        layout.addWidget(save_btn, alignment=Qt.AlignmentFlag.AlignRight)
        return w

    def _build_metasploit_tab(self) -> QWidget:
        w = QWidget()
        layout = QVBoxLayout(w)
        layout.setContentsMargins(16, 16, 16, 16)
        layout.setSpacing(12)

        info = QLabel(
            "Metasploit integration requires msfrpcd running.\n"
            "Start: msfrpcd -P <password> -S\n"
            "Configure: Settings â†’ Tools â†’ Metasploit RPC"
        )
        info.setObjectName("muted")
        info.setWordWrap(True)
        info.setStyleSheet("background:#161b22; border:1px solid #30363d; border-radius:6px; padding:12px; color:#8b949e;")
        layout.addWidget(info)

        cmd_row = QHBoxLayout()
        self._msf_cmd = QLineEdit()
        self._msf_cmd.setPlaceholderText("e.g. use exploit/windows/smb/ms17_010_eternalblue")
        run_btn = QPushButton("Execute")
        run_btn.setObjectName("danger")
        run_btn.clicked.connect(self._run_metasploit)
        cmd_row.addWidget(QLabel("Command:"))
        cmd_row.addWidget(self._msf_cmd, 1)
        cmd_row.addWidget(run_btn)
        layout.addLayout(cmd_row)

        self._msf_terminal = TerminalWidget()
        layout.addWidget(self._msf_terminal)
        return w

    def append_output(self, text: str) -> None:
        for terminal in [self._ss_terminal, self._msf_terminal]:
            terminal.append_ansi(text)

    def set_output(self, text: str) -> None:
        self._cve_output.setMarkdown(text)

    def _run_searchsploit(self) -> None:
        q = self._ss_query.text().strip()
        if q:
            self.run_tool.emit("searchsploit", {"query": q})

    def _run_cve_lookup(self) -> None:
        q = self._cve_input.text().strip()
        if q:
            kwargs = {"cve_id": q} if q.upper().startswith("CVE-") else {"keyword": q}
            self.run_tool.emit("cve_lookup", kwargs)

    def _run_metasploit(self) -> None:
        cmd = self._msf_cmd.text().strip()
        if cmd:
            self.run_tool.emit("metasploit_exec", {"command": cmd})

    def _ai_searchsploit(self) -> None:
        q = self._ss_query.text().strip()
        if q:
            self.ask_ai.emit(f"What exploits exist for '{q}'? Explain the most critical ones and how they work.")

    def _save_cve_finding(self) -> None:
        content = self._cve_output.toPlainText().strip()
        if content:
            self.save_finding.emit({
                "title": f"CVE Finding: {self._cve_input.text().strip()}",
                "description": content,
                "severity": "high",
            })
